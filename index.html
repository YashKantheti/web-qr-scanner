<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Risk Scanner - Web Version</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 375px;
      overflow: hidden;
      border-radius: 8px;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .scan-region-highlight {
      border: 2px solid #00ff00;
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      z-index: 1;
    }
    
    .risk-high {
      background-color: #fee2e2;
      border-color: #ef4444;
      color: #b91c1c;
    }
    
    .risk-medium {
      background-color: #fef3c7;
      border-color: #f59e0b;
      color: #b45309;
    }
    
    .risk-low {
      background-color: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }
    
    .risk-unknown {
      background-color: #e5e7eb;
      border-color: #6b7280;
      color: #374151;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <header class="flex flex-col md:flex-row justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">QR Code Risk Scanner</h1>
        <p class="text-gray-600">Scan QR codes and assess potential security risks</p>
      </div>
      <div class="mt-4 md:mt-0">
        <button id="historyButton" class="px-4 py-2 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 focus:outline-none flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Scan History
        </button>
      </div>
    </header>
    
    <div class="flex flex-col md:flex-row gap-6">
      <div class="bg-white p-6 rounded-lg shadow-md flex-1">
        <h2 class="text-xl font-semibold mb-4">Scanner</h2>
        
        <div class="camera-container mx-auto mb-4">
          <video id="video" playsinline></video>
          <div class="scan-region-highlight"></div>
        </div>
        
        <div class="flex justify-center space-x-4 mb-4">
          <button id="startButton" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none">
            Start Camera
          </button>
          <button id="stopButton" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 focus:outline-none" disabled>
            Stop Camera
          </button>
        </div>
        
        <div class="mt-4">
          <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Or upload QR code image:</label>
          <input type="file" id="fileInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>
      </div>
      
      <div class="bg-white p-6 rounded-lg shadow-md flex-1">
        <h2 class="text-xl font-semibold mb-4">Analysis Results</h2>
        
        <div id="resultContainer" class="hidden">
          <div id="riskIndicator" class="p-4 rounded-md border mb-4 flex items-center">
            <svg id="riskIcon" class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <p class="font-medium">Risk Level: <span id="riskLevel">Unknown</span></p>
            </div>
          </div>
          
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-1">QR Content Type:</h3>
            <p id="contentType" class="text-gray-800">-</p>
          </div>
          
          <div class="mb-4">
            <h3 class="font-medium text-gray-700 mb-1">Content:</h3>
            <p id="qrContent" class="text-gray-800 break-all bg-gray-50 p-3 rounded">-</p>
          </div>
          
          <div id="detailsContainer" class="mb-4 hidden">
            <h3 class="font-medium text-gray-700 mb-1">Details:</h3>
            <div id="detailsContent" class="text-gray-800"></div>
          </div>
          
          <div>
            <h3 class="font-medium text-gray-700 mb-1">Analysis:</h3>
            <p id="analysisResult" class="text-gray-800">-</p>
          </div>
          
          <div id="reasonsContainer" class="mt-4 hidden">
            <h3 class="font-medium text-gray-700 mb-1">Risk Factors:</h3>
            <ul id="reasonsList" class="list-disc pl-5 text-gray-800"></ul>
          </div>

          <div id="actionsContainer" class="mt-6 pt-4 border-t border-gray-200 hidden">
            <h3 class="font-medium text-gray-700 mb-2">Actions:</h3>
            <div id="actionButtons" class="flex flex-wrap gap-2">
              <button id="advancedAnalysisBtn" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                Detailed Analysis
              </button>
              <button id="reportQrBtn" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                Report as Malicious
              </button>
            </div>
          </div>
        </div>
        
        <div id="noResultContainer" class="flex flex-col items-center justify-center h-64 text-gray-400">
          <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          <p class="text-center">Scan a QR code to see analysis results</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div id="historyModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">
              Scan History
            </h3>
            <button type="button" id="closeHistoryModal" class="text-gray-400 hover:text-gray-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="overflow-auto max-h-96">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Timestamp
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Type
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Risk Level
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Content
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                <!-- History items will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Detailed Analysis Modal -->
  <div id="analysisModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">
              Detailed Analysis
            </h3>
            <button type="button" id="closeAnalysisModal" class="text-gray-400 hover:text-gray-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div id="analysisModalContent">
            <!-- Analysis results will go here -->
          </div>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" id="primaryModalAction" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            Submit
          </button>
          <button type="button" id="closeAnalysisBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Web storage for scan history and known threats
    const LOCAL_STORAGE_KEYS = {
      SCAN_HISTORY: 'qr-scanner-history',
      KNOWN_THREATS: 'qr-scanner-threats'
    };

    // Variables
    let stream = null;
    let scanning = false;
    let canvasElement;
    let canvasContext;
    let currentQrContent = null;
    let currentAnalysis = null;
    let scanHistoryDB = [];
    let knownThreatsDB = [];

    // Load from local storage
    try {
      const storedHistory = localStorage.getItem(LOCAL_STORAGE_KEYS.SCAN_HISTORY);
      if (storedHistory) {
        scanHistoryDB = JSON.parse(storedHistory);
      }
      
      const storedThreats = localStorage.getItem(LOCAL_STORAGE_KEYS.KNOWN_THREATS);
      if (storedThreats) {
        knownThreatsDB = JSON.parse(storedThreats);
      }
    } catch (error) {
      console.error('Error loading from local storage:', error);
    }

    // DOM Elements
    const video = document.getElementById('video');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const fileInput = document.getElementById('fileInput');
    const resultContainer = document.getElementById('resultContainer');
    const noResultContainer = document.getElementById('noResultContainer');
    const riskIndicator = document.getElementById('riskIndicator');
    const riskLevel = document.getElementById('riskLevel');
    const contentType = document.getElementById('contentType');
    const qrContent = document.getElementById('qrContent');
    const analysisResult = document.getElementById('analysisResult');
    const detailsContainer = document.getElementById('detailsContainer');
    const detailsContent = document.getElementById('detailsContent');
    const reasonsContainer = document.getElementById('reasonsContainer');
    const reasonsList = document.getElementById('reasonsList');
    const actionsContainer = document.getElementById('actionsContainer');
    const actionButtons = document.getElementById('actionButtons');
    
    // Modal Elements
    const historyButton = document.getElementById('historyButton');
    const historyModal = document.getElementById('historyModal');
    const closeHistoryModal = document.getElementById('closeHistoryModal');
    const historyTableBody = document.getElementById('historyTableBody');
    const analysisModal = document.getElementById('analysisModal');
    const closeAnalysisModal = document.getElementById('closeAnalysisModal');
    const closeAnalysisBtn = document.getElementById('closeAnalysisBtn');
    const analysisModalContent = document.getElementById('analysisModalContent');
    const modalTitle = document.getElementById('modalTitle');
    const primaryModalAction = document.getElementById('primaryModalAction');
    
    // Initialize canvas for QR detection
    function initCanvas() {
      canvasElement = document.createElement('canvas');
      canvasContext = canvasElement.getContext('2d');
    }
    
    // Start camera and QR scanning
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();
        
        startButton.disabled = true;
        stopButton.disabled = false;
        
        scanning = true;
        requestAnimationFrame(tick);
      } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Unable to access camera. Please check permissions.');
      }
    }
    
    // Stop camera and QR scanning
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      video.srcObject = null;
      scanning = false;
      
      startButton.disabled = false;
      stopButton.disabled = true;
    }
    
    // Process video frames for QR detection
    function tick() {
      if (!scanning) return;
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvasContext.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'dontInvert',
        });
        
        if (code) {
          // QR code detected
          handleQRCode(code.data);
          // Pause scanning briefly to prevent multiple detections
          scanning = false;
          setTimeout(() => {
            scanning = true;
            requestAnimationFrame(tick);
          }, 2000);
        } else {
          requestAnimationFrame(tick);
        }
      } else {
        requestAnimationFrame(tick);
      }
    }
    
    // Handle uploaded QR code image
    function handleFileInput(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          canvasElement.width = img.width;
          canvasElement.height = img.height;
          canvasContext.drawImage(img, 0, 0, img.width, img.height);
          
          const imageData = canvasContext.getImageData(0, 0, img.width, img.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: 'dontInvert',
          });
          
          if (code) {
            handleQRCode(code.data);
          } else {
            alert('No QR code found in the image');
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Process QR code content and display results
    async function handleQRCode(content) {
      console.log('QR Code detected:', content);
      currentQrContent = content;
      
      // Clear previous results
      detailsContainer.classList.add('hidden');
      reasonsContainer.classList.add('hidden');
      actionsContainer.classList.add('hidden');
      detailsContent.innerHTML = '';
      reasonsList.innerHTML = '';
      
      // Show loading indicator
      resultContainer.classList.remove('hidden');
      noResultContainer.classList.add('hidden');
      riskIndicator.className = 'p-4 rounded-md border mb-4 flex items-center risk-unknown';
      riskLevel.textContent = 'Analyzing...';
      contentType.textContent = 'Scanning...';
      qrContent.textContent = content;
      analysisResult.textContent = 'Performing security analysis...';
      
      // Analyze the QR code content for risks
      const analysis = await analyzeQrContent(content);
      currentAnalysis = analysis;
      
      // Save scan to history
      saveScan({
        content: content,
        riskLevel: analysis.riskLevel,
        type: analysis.details.type,
        timestamp: new Date().toISOString()
      });
      
      // Update risk level indicator
      riskIndicator.className = `p-4 rounded-md border mb-4 flex items-center risk-${analysis.riskLevel}`;
      riskLevel.textContent = analysis.riskLevel.charAt(0).toUpperCase() + analysis.riskLevel.slice(1);
      
      // Update content type
      contentType.textContent = analysis.details.type
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
      
      // Update analysis result
      analysisResult.textContent = analysis.details.analysis || 'No additional analysis available';
      
      // Show additional details if available
      const detailsToShow = [];
      
      if (analysis.details.url) {
        detailsToShow.push(`<div class="mb-2"><strong>URL:</strong> ${analysis.details.url}</div>`);
      }
      
      if (analysis.details.domain) {
        detailsToShow.push(`<div class="mb-2"><strong>Domain:</strong> ${analysis.details.domain}</div>`);
      }
      
      if (analysis.details.network) {
        detailsToShow.push(`<div class="mb-2"><strong>Network:</strong> ${analysis.details.network}</div>`);
      }
      
      if (analysis.details.security) {
        detailsToShow.push(`<div class="mb-2"><strong>Security:</strong> ${analysis.details.security}</div>`);
      }
      
      if (analysis.details.riskScore) {
        detailsToShow.push(`<div class="mb-2"><strong>Risk Score:</strong> ${analysis.details.riskScore}</div>`);
      }
      
      if (detailsToShow.length > 0) {
        detailsContainer.classList.remove('hidden');
        detailsContent.innerHTML = detailsToShow.join('');
      }
      
      // Show reasons if available
      if (analysis.details.reasons && analysis.details.reasons.length > 0) {
        reasonsContainer.classList.remove('hidden');
        reasonsList.innerHTML = '';
        
        analysis.details.reasons.forEach(reason => {
          const li = document.createElement('li');
          li.textContent = reason;
          reasonsList.appendChild(li);
        });
      }
      
      // Display action buttons
      actionsContainer.classList.remove('hidden');
      
      // URL-specific buttons
      if (analysis.details.url) {
        // Add URL-specific buttons
        const urlButtons = `
          <button id="openUrlBtn" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
            Open URL
          </button>
          <button id="copyUrlBtn" class="px-3 py-1 bg-gray-200 text-gray-800 text-sm rounded hover:bg-gray-300">
            Copy URL
          </button>
          <button id="checkReputationBtn" class="px-3 py-1 bg-blue-200 text-blue-800 text-sm rounded hover:bg-blue-300">
            Check Reputation
          </button>
        `;
        
        // Insert after the first button
        const advancedBtn = document.getElementById('advancedAnalysisBtn');
        advancedBtn.insertAdjacentHTML('afterend', urlButtons);
        
        // Add event listeners
        document.getElementById('openUrlBtn').addEventListener('click', () => {
          if (confirm(`Are you sure you want to open this URL: ${analysis.details.url}?`)) {
            window.open(analysis.details.url, '_blank');
          }
        });
        
        document.getElementById('copyUrlBtn').addEventListener('click', () => {
          navigator.clipboard.writeText(analysis.details.url);
          alert('URL copied to clipboard');
        });
        
        document.getElementById('checkReputationBtn').addEventListener('click', () => {
          showUrlReputationCheck(analysis.details.url);
        });
      }
      
      // Add event listeners for action buttons
      document.getElementById('advancedAnalysisBtn').addEventListener('click', showDetailedAnalysis);
      document.getElementById('reportQrBtn').addEventListener('click', () => {
        showReportMalicious(content, analysis.details.type);
      });
    }
    
    // QR content analysis function (client-side implementation)
    async function analyzeQrContent(qrContent) {
      try {
        // First check if this content has been previously identified as malicious
        const contentHash = await sha256(qrContent);
        const knownThreat = knownThreatsDB.find(threat => threat.contentHash === contentHash);
        
        if (knownThreat) {
          return {
            riskLevel: 'high',
            details: {
              type: 'known_threat',
              content: qrContent,
              analysis: 'This QR code has been previously identified as malicious',
              reasons: [knownThreat.reason || 'Matched against database of known threats']
            }
          };
        }
        
        // Check if QR code contains a URL
        let url = null;
        const urlRegex = /((?:https?|ftp):\/\/)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/[^\s]*)?/i;
        const urlMatch = qrContent.match(urlRegex);
        
        if (urlMatch) {
          url = urlMatch[0];
          // Ensure URL has protocol
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
          }
          
          try {
            // Create a URL object for analysis
            const urlObj = new URL(url);
            const domain = urlObj.hostname;
            
            // Check for suspicious patterns
            const suspiciousPatterns = [
              { pattern: /phish|malware|suspicious|scam|hack/, score: 0.8 },
              { pattern: /@/, score: 0.6 }, // URLs with @ symbols can be deceptive
              { pattern: /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/, score: 0.5 }, // IP addresses instead of domains
              { pattern: /bit\.ly|tinyurl|goo\.gl|t\.co|is\.gd|buff\.ly|ow\.ly|tr\.im/, score: 0.4 }, // URL shorteners
              { pattern: /login|signin|account|password|credential|verify|secure|update/, score: 0.3 }, // Words common in phishing
              { pattern: /\.(xyz|tk|ml|ga|cf|gq|top)$/, score: 0.3 } // TLDs often abused
            ];
            
            let riskScore = 0;
            const reasons = [];
            
            suspiciousPatterns.forEach(({ pattern, score }) => {
              if (pattern.test(url)) {
                riskScore += score;
                reasons.push(`URL contains suspicious pattern: ${pattern.toString().slice(1, -1)}`);
              }
            });
            
            // Simulated domain reputation check
            const maliciousDomains = ['evil.com', 'malware.com', 'phishing.com', 'scam.site'];
            if (maliciousDomains.some(d => domain.includes(d))) {
              riskScore += 1.0;
              reasons.push('Domain has known bad reputation');
            }
            
            // Analyze URL parameter complexity
            if (urlObj.search && urlObj.search.length > 50) {
              riskScore += 0.2;
              reasons.push('URL contains unusually complex parameters');
            }
            
            // Determine risk level based on score
            let riskLevel = 'low';
            if (riskScore >= 0.8) {
              riskLevel = 'high';
            } else if (riskScore >= 0.3) {
              riskLevel = 'medium';
            }
            
            return {
              riskLevel: riskLevel,
              details: {
                type: riskLevel === 'high' ? 'suspicious_url' : 'url',
                url: url,
                domain: domain,
                riskScore: riskScore.toFixed(2),
                reasons: reasons.length > 0 ? reasons : ['No specific threats detected']
              }
            };
          } catch (error) {
            console.error('Error analyzing URL:', error);
            return {
              riskLevel: 'medium',
              details: {
                type: 'malformed_url',
                url: url,
                reasons: ['URL structure is invalid or unusual']
              }
            };
          }
        }
        
        // Check if it's a contact (vCard)
        if (qrContent.startsWith('BEGIN:VCARD') && qrContent.includes('END:VCARD')) {
          // Parse vCard for potential risks
          const vCardRisks = [];
          
          // Look for unusual fields or potentially dangerous content
          if (qrContent.includes('URL:')) {
            vCardRisks.push('Contact card contains URL - verify before opening');
          }
          
          // Check for scripts or HTML that could be malicious
          if (/<script|<iframe|javascript:/i.test(qrContent)) {
            vCardRisks.push('Contact card contains potentially executable code');
            return {
              riskLevel: 'high',
              details: {
                type: 'malicious_contact_card',
                content: qrContent,
                reasons: vCardRisks
              }
            };
          }
          
          return {
            riskLevel: vCardRisks.length > 0 ? 'medium' : 'low',
            details: {
              type: 'contact_info',
              content: qrContent,
              analysis: vCardRisks.length > 0 
                ? 'QR code contains contact information with potential risks' 
                : 'QR code contains standard contact information',
              reasons: vCardRisks.length > 0 ? vCardRisks : undefined
            }
          };
        }
        
        // Check if it's WiFi credentials
        if (qrContent.startsWith('WIFI:')) {
          // Parse WiFi QR code
          const ssidMatch = qrContent.match(/S:([^;]+)/);
          const securityMatch = qrContent.match(/T:([^;]+)/);
          
          const ssid = ssidMatch ? ssidMatch[1] : 'Unknown';
          const security = securityMatch ? securityMatch[1].toUpperCase() : 'Unknown';
          
          const wifiRisks = [];
          
          // Check encryption type
          if (security === 'NONE' || security === 'WEP') {
            wifiRisks.push(`Network uses insecure encryption (${security})`);
          }
          
          // Check for potentially malicious SSIDs
          const suspiciousSSIDPatterns = [
            /free\s*wifi/i,
            /public\s*wifi/i,
            /airport|hotel|cafe/i,
            /[0-9a-f]{12}/i // MAC address format, often used in spoofing
          ];
          
          for (const pattern of suspiciousSSIDPatterns) {
            if (pattern.test(ssid)) {
              wifiRisks.push('Network name matches patterns often used in rogue access points');
              break;
            }
          }
          
          return {
            riskLevel: wifiRisks.length > 0 ? 'high' : 'medium',
            details: {
              type: 'wifi_credentials',
              network: ssid,
              security: security,
              content: qrContent,
              analysis: 'QR code contains WiFi network credentials. Only connect to trusted networks.',
              reasons: wifiRisks.length > 0 ? wifiRisks : ['No specific security issues detected, but always verify WiFi networks before connecting']
            }
          };
        }
        
        // Check if it's a cryptocurrency payment request
        if (qrContent.match(/^(bitcoin|ethereum|litecoin):/i)) {
          return {
            riskLevel: 'high',
            details: {
              type: 'cryptocurrency_payment',
              content: qrContent,
              analysis: 'QR code contains cryptocurrency payment information. Verify recipient carefully before sending funds.',
              reasons: ['Cryptocurrency transactions are irreversible if sent to wrong address']
            }
          };
        }
        
        // Check if it's a calendar event
        if (qrContent.startsWith('BEGIN:VCALENDAR') && qrContent.includes('END:VCALENDAR')) {
          // Parse for URLs or suspicious content
          const calendarRisks = [];
          if (/<script|<iframe|javascript:/i.test(qrContent)) {
            calendarRisks.push('Calendar event contains potentially executable code');
          }
          
          if (/https?:\/\//i.test(qrContent)) {
            calendarRisks.push('Calendar event contains web links - verify before opening');
          }
          
          return {
            riskLevel: calendarRisks.length > 0 ? 'medium' : 'low',
            details: {
              type: 'calendar_event',
              content: qrContent,
              analysis: 'QR code contains calendar event information',
              reasons: calendarRisks.length > 0 ? calendarRisks : undefined
            }
          };
        }
        
        // Check for potentially executable content
        if (/<script|<iframe|javascript:|data:text\/html|data:application\/|ssh:|ftp:/i.test(qrContent)) {
          return {
            riskLevel: 'high',
            details: {
              type: 'potentially_executable',
              content: qrContent,
              analysis: 'QR code contains content that could execute code or access restricted resources',
              reasons: ['Contains patterns associated with executable code or protocols']
            }
          };
        }
        
        // Default response for other types of content
        return {
          riskLevel: 'unknown',
          details: {
            type: 'other',
            content: qrContent,
            analysis: 'Unknown QR code content type - inspect carefully before proceeding'
          }
        };
      } catch (error) {
        console.error('Error analyzing QR code:', error);
        return {
          riskLevel: 'error',
          details: {
            error: error.message
          }
        };
      }
    }
    
    // Show detailed analysis in modal
    function showDetailedAnalysis() {
      if (!currentAnalysis) return;
      
      // Update modal title and buttons
      modalTitle.textContent = 'Detailed Analysis';
      primaryModalAction.style.display = 'none';
      
      let modalContent = `
        <div class="mb-4">
          <div class="${getClassForRiskLevel(currentAnalysis.riskLevel)} p-3 rounded-md">
            <h4 class="font-bold text-lg mb-1">Risk Level: ${currentAnalysis.riskLevel.toUpperCase()}</h4>
            <p>${currentAnalysis.details.analysis || ''}</p>
          </div>
        </div>
        
        <div class="mb-4">
          <h4 class="font-semibold text-gray-700 mb-2">QR Content:</h4>
          <pre class="bg-gray-50 p-3 rounded overflow-x-auto">${currentQrContent}</pre>
        </div>
      `;
      
      // Add detailed analysis sections based on content type
      if (currentAnalysis.details.type === 'url' || currentAnalysis.details.type === 'suspicious_url') {
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">URL Analysis:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Domain:</strong> ${currentAnalysis.details.domain || 'N/A'}</p>
              <p><strong>Risk Score:</strong> ${currentAnalysis.details.riskScore || 'N/A'}</p>
              ${
                currentAnalysis.details.reasons ? 
                `<div class="mt-2">
                  <strong>Risk Factors:</strong>
                  <ul class="list-disc ml-5 mt-1">
                    ${currentAnalysis.details.reasons.map(reason => `<li>${reason}</li>`).join('')}
                  </ul>
                </div>` : ''
              }
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Verify the URL is from a trusted source</li>
              <li>Check for misspellings in the domain</li>
              <li>Be cautious of shortened URLs</li>
              <li>Never enter credentials on suspicious sites</li>
            </ul>
          </div>
        `;
      } else if (currentAnalysis.details.type === 'wifi_credentials') {
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">WiFi Network Analysis:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Network:</strong> ${currentAnalysis.details.network || 'N/A'}</p>
              <p><strong>Security:</strong> ${currentAnalysis.details.security || 'N/A'}</p>
              ${
                currentAnalysis.details.reasons ? 
                `<div class="mt-2">
                  <strong>Risk Factors:</strong>
                  <ul class="list-disc ml-5 mt-1">
                    ${currentAnalysis.details.reasons.map(reason => `<li>${reason}</li>`).join('')}
                  </ul>
                </div>` : ''
              }
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Only connect to networks from trusted sources</li>
              <li>Avoid public WiFi for sensitive activities</li>
              <li>Use a VPN when connecting to public networks</li>
              <li>Verify the network with the provider before connecting</li>
            </ul>
          </div>
        `;
      } else {
        // Generic recommendations for other types
        modalContent += `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Safety Recommendations:</h4>
            <ul class="list-disc ml-5">
              <li>Always verify QR codes from unknown sources</li>
              <li>Be cautious with QR codes in public places</li>
              <li>Check the content before taking action</li>
              <li>Keep your device's software updated</li>
            </ul>
          </div>
        `;
      }
      
      analysisModalContent.innerHTML = modalContent;
      analysisModal.classList.remove('hidden');
    }
    
    // Show URL reputation check
    function showUrlReputationCheck(url) {
      // Update modal title and buttons
      modalTitle.textContent = 'URL Reputation Check';
      primaryModalAction.style.display = 'none';
      
      analysisModalContent.innerHTML = `
        <div class="flex justify-center items-center h-40">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      `;
      
      analysisModal.classList.remove('hidden');
      
      // Simulate reputation check with a delay
      setTimeout(() => {
        const reputationScore = Math.random();
        let reputation;
        
        if (reputationScore > 0.95) {
          reputation = "malicious";
        } else if (reputationScore > 0.85) {
          reputation = "suspicious";
        } else if (reputationScore > 0.7) {
          reputation = "neutral";
        } else {
          reputation = "safe";
        }
        
        let statusClass;
        let statusIcon;
        
        switch (reputation) {
          case 'safe':
            statusClass = 'bg-green-100 text-green-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>`;
            break;
          case 'malicious':
            statusClass = 'bg-red-100 text-red-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>`;
            break;
          case 'suspicious':
            statusClass = 'bg-yellow-100 text-yellow-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>`;
            break;
          default:
            statusClass = 'bg-gray-100 text-gray-800';
            statusIcon = `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>`;
        }
        
        const domain = new URL(url).hostname;
        const categories = reputation === "safe" ? ["trustworthy"] : 
                           reputation === "malicious" ? ["malware", "phishing"] : 
                           ["unverified"];
        
        analysisModalContent.innerHTML = `
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">URL Reputation:</h4>
            <div class="${statusClass} p-3 rounded-md flex items-center">
              ${statusIcon}
              <div>
                <p class="font-semibold">${capitalizeFirstLetter(reputation)}</p>
                <p class="text-sm">Reputation Score: ${reputationScore.toFixed(2)}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">Domain Information:</h4>
            <div class="bg-gray-50 p-3 rounded">
              <p><strong>Domain:</strong> ${domain}</p>
              <p><strong>Categories:</strong> ${categories.join(', ')}</p>
            </div>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-500">
              <strong>Note:</strong> This reputation check simulates what a real security service would provide. In a production app, 
              this would use services like Google Safe Browsing, VirusTotal, or other URL reputation APIs.
            </p>
          </div>
        `;
      }, 1500);
    }
    
    // Show report malicious QR code dialog
    function showReportMalicious(content, contentType) {
      // Update modal title and buttons
      modalTitle.textContent = 'Report Malicious QR Code';
      primaryModalAction.textContent = 'Submit Report';
      primaryModalAction.style.display = 'block';
      
      analysisModalContent.innerHTML = `
        <div class="mb-4">
          <p class="mb-4">Help improve security by reporting this QR code as malicious.</p>
          
          <div class="mb-4">
            <label for="reportReason" class="block text-sm font-medium text-gray-700 mb-1">Reason for reporting:</label>
            <select id="reportReason" class="w-full p-2 border border-gray-300 rounded">
              <option value="phishing">Phishing attempt</option>
              <option value="malware">Contains malware</option>
              <option value="scam">Scam or fraud</option>
              <option value="inappropriate">Inappropriate content</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label for="reportDetails" class="block text-sm font-medium text-gray-700 mb-1">Additional details (optional):</label>
            <textarea id="reportDetails" class="w-full p-2 border border-gray-300 rounded h-24"></textarea>
          </div>
        </div>
      `;
      
      analysisModal.classList.remove('hidden');
      
      // Set up submit action
      primaryModalAction.onclick = () => {
        const reason = document.getElementById('reportReason').value;
        const details = document.getElementById('reportDetails').value;
        
        // Save threat to local storage
        saveThreat({
          content: content,
          type: contentType,
          reason: `${reason}${details ? ': ' + details : ''}`,
          dateAdded: new Date().toISOString()
        });
        
        analysisModalContent.innerHTML = `
          <div class="p-4 bg-green-100 text-green-800 rounded-md">
            <p class="font-semibold">Thank you for your report!</p>
            <p class="mt-2">This QR code has been added to the known threats database. Future scans will identify it as malicious.</p>
          </div>
        `;
        
        // Reset button
        primaryModalAction.style.display = 'none';
      };
    }
    
    // Load scan history
    function loadScanHistory() {
      historyTableBody.innerHTML = '';
      
      if (scanHistoryDB.length === 0) {
        historyTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
              No scan history found
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort history by timestamp (newest first)
      scanHistoryDB.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      scanHistoryDB.forEach(scan => {
        const row = document.createElement('tr');
        
        // Format date
        const date = new Date(scan.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        // Truncate content if too long
        const truncatedContent = scan.content.length > 30 
          ? scan.content.substring(0, 30) + '...' 
          : scan.content;
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${formattedDate}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${formatContentType(scan.type)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskLevelClass(scan.riskLevel)}">
              ${capitalizeFirstLetter(scan.riskLevel)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate">
            ${truncatedContent}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="text-indigo-600 hover:text-indigo-900 rescan-btn" data-content="${escapeHtml(scan.content)}">
              Rescan
            </button>
          </td>
        `;
        
        historyTableBody.appendChild(row);
      });
      
      // Add event listeners to rescan buttons
      document.querySelectorAll('.rescan-btn').forEach(button => {
        button.addEventListener('click', () => {
          const content = button.getAttribute('data-content');
          if (content) {
            handleQRCode(content);
            historyModal.classList.add('hidden');
          }
        });
      });
    }
    
    // Save scan to history
    function saveScan(scan) {
      scanHistoryDB.push(scan);
      
      // Keep only last 100 scans
      if (scanHistoryDB.length > 100) {
        scanHistoryDB = scanHistoryDB.slice(-100);
      }
      
      // Save to local storage
      try {
        localStorage.setItem(LOCAL_STORAGE_KEYS.SCAN_HISTORY, JSON.stringify(scanHistoryDB));
      } catch (error) {
        console.error('Error saving to local storage:', error);
      }
    }
    
    // Save threat to database
    async function saveThreat(threat) {
      // Calculate hash
      const contentHash = await sha256(threat.content);
      
      const threatData = {
        contentHash,
        content: threat.content,
        type: threat.type,
        reason: threat.reason,
        dateAdded: threat.dateAdded
      };
      
      knownThreatsDB.push(threatData);
      
      // Save to local storage
      try {
        localStorage.setItem(LOCAL_STORAGE_KEYS.KNOWN_THREATS, JSON.stringify(knownThreatsDB));
        return { success: true };
      } catch (error) {
        console.error('Error saving to local storage:', error);
        return { success: false, error: error.message };
      }
    }
    
    // Helper functions
    async function sha256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function formatContentType(type) {
      return type
        .split('_')
        .map(word => capitalizeFirstLetter(word))
        .join(' ');
    }
    
    function getRiskLevelClass(level) {
      switch (level) {
        case 'high':
          return 'bg-red-100 text-red-800';
        case 'medium':
          return 'bg-yellow-100 text-yellow-800';
        case 'low':
          return 'bg-green-100 text-green-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }
    
    function getClassForRiskLevel(level) {
      switch (level) {
        case 'high':
          return 'bg-red-100 text-red-800 border border-red-200';
        case 'medium':
          return 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        case 'low':
          return 'bg-green-100 text-green-800 border border-green-200';
        default:
          return 'bg-gray-100 text-gray-800 border border-gray-200';
      }
    }
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Event listeners
    window.addEventListener('DOMContentLoaded', initCanvas);
    startButton.addEventListener('click', startCamera);
    stopButton.addEventListener('click', stopCamera);
    fileInput.addEventListener('change', handleFileInput);
    
    // Modal event listeners
    historyButton.addEventListener('click', () => {
      loadScanHistory();
      historyModal.classList.remove('hidden');
    });
    
    closeHistoryModal.addEventListener('click', () => {
      historyModal.classList.add('hidden');
    });
    
    closeAnalysisModal.addEventListener('click', () => {
      analysisModal.classList.add('hidden');
    });
    
    closeAnalysisBtn.addEventListener('click', () => {
      analysisModal.classList.add('hidden');
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === historyModal) {
        historyModal.classList.add('hidden');
      }
      
      if (event.target === analysisModal) {
        analysisModal.classList.add('hidden');
      }
    });
  </script>
</body>
</html>